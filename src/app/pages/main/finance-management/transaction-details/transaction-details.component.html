<main class="transaction-main-wrapper flex flex-col w-full min-h-screen p-6">
  <!-- Breadcrumb -->
  <div class="mb-8">
    <app-breadcrumb
      [items]="[
        { label: 'Financial Management', url: '/finance-management' },
        { label: 'Transaction Details', url: '/finance-management/transaction/' + transactionId }
      ]"
    ></app-breadcrumb>
  </div>

  <!-- Header Section -->
  <div class="flex items-center justify-between mb-8">
    <div class="flex items-center gap-4">
      <button 
        nz-button 
        nzType="default" 
        nzSize="large"
        (click)="onBack()"
        class="flex items-center rounded-lg">
        <span nz-icon nzType="arrow-left" class="flex items-center"></span>
        <span class="flex items-center">Back</span>
      </button>
      <div>
        <h1 class="text-[#4F4F4F] dark:text-gray-400 text-[28px] font-semibold mb-1">Transaction Details.</h1>
        <p class="text-[#7A7A7A] dark:text-gray-400 text-[14px]" *ngIf="transaction">
          Reference: {{ transaction.reference }}
        </p>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="flex items-center justify-center py-20">
    <nz-spin nzSize="large"></nz-spin>
  </div>

  <!-- Transaction Not Found -->
  <div *ngIf="!loading && !transaction" class="text-center py-20">
    <nz-empty nzNotFoundContent="Transaction not found"></nz-empty>
    <button nz-button nzType="primary" (click)="onBack()" class="mt-4 flex items-center justify-center">
      <span class="flex items-center">Return to Financial Management</span>
    </button>
  </div>

  <!-- Transaction Details Content -->
  <div *ngIf="!loading && transaction" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Main Transaction Information -->
    <div class="lg:col-span-2">
      <nz-card class="transaction-info-card transaction-container rounded-lg border-2 border-[#EEF2F6] dark:border-gray-600" [nzBodyStyle]="{ padding: '32px' }">
        <div class="mb-6">
          <h2 class="text-[#4F4F4F] dark:text-gray-400 text-[20px] font-semibold mb-4">Transaction Information</h2>
        </div>
        <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }" class="custom-descriptions">
          <nz-descriptions-item nzTitle="Transaction ID">
            <span class="text-[#4F4F4F] dark:text-gray-400 font-medium">{{ transaction.id }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Payment Reference">
            <span class="text-[#4F4F4F] dark:text-gray-400 font-medium">{{ transaction.reference }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Gateway Reference">
            <span class="text-[#4F4F4F] dark:text-gray-400 font-medium">{{ transaction.gatewayReference || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Payment Method">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.paymentMethod }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Amount">
            <span class="text-[#E41C24] font-bold text-[18px]">{{ transaction.amount }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Status">
            <nz-tag [nzColor]="getStatusColor(transaction.status)" class="px-3 py-1 rounded-full font-medium">
              {{ transaction.status }}
            </nz-tag>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Created At">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.createdAt || transaction.date | date: 'medium' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Paid At">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.paidAt || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Approved By">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.approvedBy || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Approved At">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.approvedAt || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Reviewed By">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.reviewedBy || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Reviewed At">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.reviewedAt || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Error Message" [nzSpan]="2" *ngIf="transaction.errorMessage">
            <span class="text-[#7A7A7A] dark:text-gray-400">{{ transaction.errorMessage }}</span>
          </nz-descriptions-item>
        </nz-descriptions>
      </nz-card>

      <!-- Client Information -->
      <nz-card class="client-info-card transaction-container rounded-lg border-2 border-[#EEF2F6] dark:border-gray-600" [nzBodyStyle]="{ padding: '32px' }">
        <div class="mb-6">
          <h2 class="text-[#4F4F4F] dark:text-gray-400 text-[20px] font-semibold mb-4">Client Information</h2>
        </div>
        <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }" class="custom-descriptions">
          <nz-descriptions-item nzTitle="Name">
            <span class="text-[#4F4F4F] dark:text-gray-400 font-medium">{{ transaction.client }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Email">
            <a [href]="'mailto:' + transaction.clientEmail" class="text-[#E41C24] hover:text-[#d1181f]">{{ transaction.clientEmail }}</a>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Phone">
            <a [href]="'tel:' + transaction.clientPhone" class="text-[#E41C24] hover:text-[#d1181f]">{{ transaction.clientPhone }}</a>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mode of Payment">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.modeOfPayment }}</span>
          </nz-descriptions-item>
        </nz-descriptions>
      </nz-card>

      <!-- Purchase Information -->
      <nz-card class="transaction-container rounded-lg border-2 border-[#EEF2F6] dark:border-gray-600" [nzBodyStyle]="{ padding: '32px' }">
        <div class="mb-6">
          <h2 class="text-[#4F4F4F] dark:text-gray-400 text-[20px] font-semibold mb-4">Purchase Information</h2>
        </div>
        <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }" class="custom-descriptions">
          <nz-descriptions-item nzTitle="Property">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.propertyName || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Location">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.propertyLocation || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Unit ID">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.unitId || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Unit Price">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.unitPrice || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Total Price">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.totalPrice || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Initial Due">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.initialPaymentDue || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Balance Due">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.balanceDue || '—' }}</span>
          </nz-descriptions-item>
          <nz-descriptions-item nzTitle="Purchase Status">
            <span class="text-[#4F4F4F] dark:text-gray-400">{{ transaction.purchase?.status || '—' }}</span>
          </nz-descriptions-item>
        </nz-descriptions>
      </nz-card>
    </div>

    <!-- Sidebar Information -->
    <div class="lg:col-span-1">
      <!-- Quick Actions -->
      <nz-card class="quick-actions-card transaction-container rounded-lg border-2 border-[#EEF2F6] dark:border-gray-600" [nzBodyStyle]="{ padding: '24px' }">
        <div class="mb-4">
          <h3 class="text-[#4F4F4F] dark:text-gray-400 text-[18px] font-semibold">Quick Actions</h3>
        </div>
        <div class="quick-actions-buttons">
          <!-- Download Evidence (only for transactions with evidence) -->
          <button 
            *ngIf="hasEvidenceOfPayment()"
            nz-button 
            nzType="default" 
            nzBlock 
            class="rounded-lg h-12 font-medium mb-3" 
            (click)="onDownloadEvidence()">
            <span nz-icon nzType="download" nzTheme="outline" class="flex items-center"></span>
            <span class="flex items-center">Evidence of Payment</span>
          </button>
          <!-- Edit transaction: upload (or replace) proof of payment -->
          <button 
            *ngIf="isBankTransferOrCheck()"
            nz-button 
            nzType="default" 
            nzBlock 
            class="rounded-lg h-12 font-medium mb-3" 
            (click)="showEditModal()">
            <span nz-icon nzType="edit" nzTheme="outline" class="flex items-center"></span>
            <span class="flex items-center">Edit Transaction (Upload Proof)</span>
          </button>

          <!-- Action Buttons Based on Status and Payment Mode (only for pending transactions) -->
          
          <!-- For Paystack Successful (but still pending approval) -->
          <button 
            *ngIf="isPaystackTransaction() && canApprovePaystack()"
            nz-button 
            nzType="primary" 
            nzBlock 
            class="rounded-lg h-12 font-medium bg-green-600 border-green-600" 
            [nzLoading]="approveLoading"
            (click)="onApproveAndSendToLegal()">
            <span nz-icon nzType="check" class="flex items-center"></span>
            <span class="flex items-center">Approve & Send to Legal</span>
          </button>

          <!-- For Bank Transfer/Check Validation -->
          <button 
            *ngIf="isBankTransferOrCheck() && canTakeActions() && hasEvidenceOfPayment()"
            nz-button 
            nzType="primary" 
            nzBlock 
            class="rounded-lg h-12 font-medium bg-blue-600 border-blue-600" 
            (click)="onValidateTransaction()">
            <span nz-icon nzType="check-circle" class="flex items-center"></span>
            <span class="flex items-center">Validate & Approve</span>
          </button>

          <!-- Review Transaction (Bank transfer/cheque): choose reupload or reinitiate -->
          <button 
            *ngIf="isBankTransferOrCheck() && canTakeActions()"
            nz-button 
            nzType="default" 
            nzBlock 
            class="rounded-lg h-12 font-medium border-orange-300 text-orange-600" 
            (click)="showReviewModal()">
            <span nz-icon nzType="eye" class="flex items-center"></span>
            <span class="flex items-center">Review Transaction</span>
          </button>


          <nz-divider class="my-4"></nz-divider>

          <!-- Send to Client (for successful transactions) -->
          <button 
            *ngIf="isSuccessfulTransaction()"
            nz-button 
            nzType="default" 
            nzBlock 
            class="rounded-lg h-12 font-medium" 
            (click)="showSendToClientModal()">
            <span nz-icon nzType="mail" class="flex items-center"></span>
            <span class="flex items-center">Send to Client</span>
          </button>

          <!-- Print Details -->
          <button 
            nz-button 
            nzType="default" 
            nzBlock 
            class="rounded-lg h-12 font-medium">
            <span nz-icon nzType="printer" class="flex items-center"></span>
            <span class="flex items-center">Print Details</span>
          </button>
        </div>
      </nz-card>

      <!-- Transaction Status -->
      <nz-card class="status-info-card transaction-container rounded-lg border-2 border-[#EEF2F6] dark:border-gray-600" [nzBodyStyle]="{ padding: '24px' }">
        <div class="mb-4">
          <h3 class="text-[#4F4F4F] dark:text-gray-400 text-[18px] font-semibold">Status Information</h3>
        </div>
        <div class="text-center">
          <nz-tag [nzColor]="getStatusColor(transaction.status)" class="text-[16px] px-6 py-3 rounded-full font-semibold">
            {{ transaction.status }}
          </nz-tag>
          <p class="text-[#7A7A7A] dark:text-gray-400 mt-4 text-[14px]">
            Last updated: {{ transaction.updatedAt || transaction.date | date: 'medium' }}
          </p>
      </div>
      </nz-card>
      
      <!-- removed review/applied cards per spec -->
    </div>
  </div>

  <!-- Review Transaction Modal -->
  <nz-modal
    [(nzVisible)]="isReviewModalVisible"
    nzTitle="Review Transaction"
    nzWidth="520px"
    (nzOnCancel)="handleReviewCancel()"
    (nzOnOk)="handleReviewOk()">
    <ng-container *nzModalContent>
      <div class="mb-4">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Select a decision for this manual payment. You may also add a note for the user.
        </p>
        <nz-form-item>
          <nz-form-label>Decision</nz-form-label>
          <nz-form-control>
            <nz-radio-group [(ngModel)]="reviewDecision">
              <label nz-radio nzValue="request_reupload"><span class="ml-2">Request user to reupload proof of payment</span></label>
              <label nz-radio nzValue="reinitiate"><span class="ml-2">Ask user to reinitiate the transaction</span></label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>
        <nz-form-item class="mt-3">
          <nz-form-label>Message to user (optional)</nz-form-label>
          <nz-form-control>
            <textarea
              nz-input
              [(ngModel)]="reviewComment"
              placeholder="Add helpful details for the user..."
              rows="4"
              class="w-full"></textarea>
          </nz-form-control>
        </nz-form-item>
      </div>
    </ng-container>
  </nz-modal>

  <!-- Edit Transaction Modal: Upload Proof -->
  <nz-modal
    [(nzVisible)]="isEditModalVisible"
    nzTitle="Upload Proof of Payment"
    nzWidth="500px"
    (nzOnCancel)="handleEditCancel()"
    (nzOnOk)="handleEditOk()">
    <ng-container *nzModalContent>
      <div class="mb-4">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Select the image or PDF proof of payment to attach to this transaction.
        </p>
        <input type="file" accept="image/*,application/pdf" (change)="onProofFileChange($event)" />
      </div>
    </ng-container>
  </nz-modal>


  <!-- Validate Transaction Modal -->
  <nz-modal
    [(nzVisible)]="isValidateModalVisible"
    nzTitle="Validate Transaction & Send to Legal"
    nzWidth="500px"
    [nzOkLoading]="validateLoading"
    (nzOnCancel)="handleValidateCancel()"
    (nzOnOk)="handleValidateOk()">
    <ng-container *nzModalContent>
      <div class="mb-4">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Please provide instructions for the legal team to proceed with documentation. This will help them understand the specific requirements for this transaction.
        </p>
        <nz-form-item>
          <nz-form-label>Instructions for Legal Team</nz-form-label>
          <nz-form-control>
            <textarea 
              nz-input 
              [(ngModel)]="validateComment" 
              rows="4" 
              placeholder="Enter instructions for legal team regarding documentation process..."
              class="w-full">
            </textarea>
          </nz-form-control>
        </nz-form-item>
        <div class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
          <p class="text-sm text-green-600 dark:text-green-400">
            <span nz-icon nzType="check-circle" class="mr-1"></span>
            Transaction will be validated and sent to legal team for document processing
          </p>
        </div>
      </div>
    </ng-container>
  </nz-modal>

  <!-- Send to Client Modal -->
  <nz-modal
    [(nzVisible)]="isSendToClientModalVisible"
    nzTitle="Send to Client"
    nzWidth="400px"
    (nzOnCancel)="handleSendToClientCancel()"
    (nzOnOk)="handleSendToClientOk()">
    <ng-container *nzModalContent>
      <div class="mb-4">
        <p class="text-gray-600 dark:text-gray-400 mb-4">
          Choose what to send to the client:
        </p>
        <nz-form-item>
          <nz-form-label>Document Type</nz-form-label>
          <nz-form-control>
            <nz-radio-group [(ngModel)]="sendToClientType">
              <label nz-radio nzValue="receipt">
                <span class="ml-2">Receipt</span>
              </label>
              <label nz-radio nzValue="invoice">
                <span class="ml-2">Invoice</span>
              </label>
            </nz-radio-group>
          </nz-form-control>
        </nz-form-item>
        <div class="mt-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
          <p class="text-sm text-blue-600 dark:text-blue-400">
            <span nz-icon nzType="info-circle" class="mr-1"></span>
            The selected document will be sent to <strong>{{ transaction?.client }}</strong> at <strong>{{ transaction?.clientEmail }}</strong>
          </p>
        </div>
      </div>
    </ng-container>
  </nz-modal>
</main>
