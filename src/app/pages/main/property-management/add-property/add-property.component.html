<main class="flex flex-col w-full">
  <div class="flex flex-col mb-10">
    <app-breadcrumb
      [items]="[
        { label: 'Property Management', url: '/main/property-management' },
        { label: 'Add New Property' }
      ]"
    ></app-breadcrumb>
  </div>
 <div class="flex gap-6">
    <div class="flex bg-background p-5 h-fit border border-[#EBEBEB] rounded-lg max-w-2/5">
        <nz-steps class="!text-primary" [nzCurrent]="currentStep" nzDirection="vertical" nzSize="small">
            <nz-step nzTitle="Details" nzDescription="Enter basic details such as name, category"></nz-step>
            <nz-step nzTitle="Features/Amenities" nzDescription="Enter available amenities and facilities of the properties"></nz-step>
            <nz-step nzTitle="Property Images" nzDescription="Add property images"></nz-step>
            <nz-step nzTitle="Payment Plan" nzDescription="Set payment plan"></nz-step>
            <!-- <nz-step nzTitle="Payment Installment Plan" nzDescription="Set payment installment plan"></nz-step> -->
        </nz-steps>
    </div>
  @if (currentStep == 0) {
    <div
      class="flex flex-col gap-6 py-5 px-8 border border-[#EBEBEB] rounded-lg w-full bg-background mb-8"
    >
    <h1 class="!text-primary">Basic Details</h1>
    <form nz-form [formGroup]="formBasic" (ngSubmit)="submitFormBasic()">
    <div class="flex flex-col justify-center gap-y-8 w-full">
      <div class="w-full">
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="category" [nzNoColon]="true">
          <span>Property Category</span>
        </nz-form-label>
        <nz-form-control
            nzErrorTip="Please select property category">
            <nz-select
                id="type_id"
                formControlName="type_id"
                nzAllowClear
                nzPlaceHolder="Select a category for this property"
                class="basis-2/3">
                @for(category of propertyTypeOptions; track category.value) {
                <nz-option [nzValue]="category.value" [nzLabel]="category.name"></nz-option>
                }
            </nz-select>
        </nz-form-control>
      </div>
      <div>
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="name" [nzNoColon]="true">
          <span>Property Name</span>
        </nz-form-label>
        <nz-form-control
          nzErrorTip="Please enter property name!"
        >
          <input
            nz-input
            id="name"
            placeholder="Enter property name"
            formControlName="name"
          />
        </nz-form-control>
      </div>
      <div>
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="location" [nzNoColon]="true">
            Property Location
        </nz-form-label
        >
        <nz-form-control
          nzErrorTip="Please enter property location"
        >
          <input
            nz-input
            formControlName="location"
            placeholder="Enter Property location"
            id="location"
          />
        </nz-form-control>
      </div>

      <div>
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="address" [nzNoColon]="true">
          <span>Property Address</span>
        </nz-form-label>
        <nz-form-control
          nzErrorTip="Please enter property address!"
        >
          <input
            nz-input
            id="address"
            placeholder="Enter property address"
            formControlName="address"
          />
        </nz-form-control>
      </div>

      <div>
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="description" [nzNoColon]="true">
            Property Description
        </nz-form-label
        >
        <nz-form-control
          nzErrorTip="Please enter property description"
        >
          <textarea
            nz-input
            formControlName="description"
            placeholder="Enter Property description"
            id="description"
            rows="4"
          ></textarea>
        </nz-form-control>
      </div>

    </div>

    <div class="flex items-center justify-end gap-6 my-12">
      <button
        type="submit"
        class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
        [disabled]="isLoading"
      >
        Save & Continue
      </button>
    </div>
  </form>
  </div>
  }

  @if (currentStep == 1) {
    <div
      class="flex flex-col gap-6 py-5 px-8 border border-[#EBEBEB] rounded-lg w-full bg-background mb-8"
    >
    <h1 class="!text-primary">Features/Amenities</h1>
    <form nz-form [formGroup]="formAmenities" (ngSubmit)="submitFormAmenities()">
    <div class="flex flex-col justify-center gap-y-8 w-full">
      <div class="w-full">
        <nz-form-label [nzSm]="6" [nzXs]="24" nzFor="category" [nzNoColon]="true">
          <span>Select Amenities</span>
        </nz-form-label>
        <nz-form-control
          nzErrorTip="Please select property amenities"
        >
          <nz-select
            id="features"
            nzShowSearch
            nzAllowClear
            nzPlaceHolder="Select property amenities"
            formControlName="features"
            nzMode="multiple"
            nzPlacement="bottomRight"
            nzSuffixIcon="dashboard"
            >
            @for(feature of adminFeatures; track feature.id) {
            <nz-option [nzValue]="feature.id" [nzLabel]="feature.name">
              <ng-template #nzOptionCustomContent>
                <div class="flex items-center gap-2">
                  <nz-icon [nzType]="feature.icon" />
                  {{ feature.name }}
                </div>
              </ng-template>
            </nz-option>
            }
        </nz-select>
        </nz-form-control>
      </div>

    </div>

    <div class="flex items-center justify-end gap-6 my-12">
      <button
        type="submit"
        class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
        [disabled]="isLoading">Save & Continue</button>
    </div>
  </form>
  </div>
  }

  @if (currentStep == 2) {
    <div
      class="flex flex-col gap-2 py-5 px-8 border border-[#EBEBEB] rounded-lg w-full bg-background mb-8"
    >
    <h1 class="!text-primary">Property Images</h1>
    <p class="!text-medium text-[#7A7A7A]">
      Upload images of the property here, upload within 4 to 10 images, Make sure the images are of good quality
    </p>

    <div class="flex flex-col mt-8">
        <div class="flex items-center gap-6 py-5">
        <div class="grid grid-cols-3 items-center gap-6">
        @for(img of uploadedImages; track img) {
          <div class="relative">
            <img
              src="{{img}}"
              alt="property image"
              class="w-full h-full rounded-lg object-cover hover:scale-105 transition-transform duration-200 hover:brightness-50"
          />
            <app-icon class="!text-white !text-sm absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 cursor-pointer hover:scale-150 hover:!text-red-500" name="trash" (click)="removeImage(img)"></app-icon>
          </div>
        }
        <div class="relative flex items-center justify-center cursor-pointer border-2 border-dashed border-gray-400 w-full aspect-square rounded-lg hover:bg-gray-100 !p-12">
            <input
                type="file"
                id="fileInput"
                (change)="onImageSelected($event)"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-not-allowed"
                [disabled]="isLoading"
                accept="image/*"
            />
            <label for="fileInput" class="flex justify-center w-fit px-4 py-2 bg-primary text-white rounded cursor-pointer">
                Upload
            </label>
        </div>
      </div>
      </div>
        <div class="flex items-center justify-end gap-6 my-12">
             <button
                type="submit"
                class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
                [disabled]="isLoading || uploadedImages.length < 4 || uploadedImages.length > 10"
                (click)="submitImage()">Save & Continue
              </button>
              <!--  || uploadedImages.length < 4 -->
        </div>
    </div>

  </div>
  }

  @if (currentStep == 3) {
    <div class="flex flex-col gap-12 w-full">
      <form *ngIf="!unitSaved" nz-form [formGroup]="unitTypeForm" class="w-full">
        <div class="flex flex-col gap-6">
            <div class="flex justify-end gap-4">
              <button
                type="button"
                class="!text-primary hover:text-red-800 text-sm font-medium cursor-pointer disabled:!text-gray-200 disabled:cursor-not-allowed"
                (click)="addUnitType()"
                [disabled]="isLoading || unitSaved"
              >
                + Add Unit
              </button>
              
            </div>
          <div *ngIf="unitTypesOptions.length; else noUnitTypes" formArrayName="unit_types" class="flex flex-col gap-6 bg-gray-100 p-6 rounded-lg border border-gray-200">
            <div *ngFor="let unitType of unitTypes.controls; let i = index; trackBy: trackByUnitType" [formGroupName]="i">
              <div class="flex flex-col gap-2 mb-2">
                <label [for]="'unit_type_id_' + i" class="text-gray-500 text-xs font-medium">
                  Unit Type
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control nzErrorTip="Please select a unit type">
                  <nz-select
                    [id]="'unit_type_id_' + i"
                    formControlName="unit_type_id"
                    nzPlaceHolder="Select a unit type for this property"
                    class="w-full"
                    [nzSize]="'large'"
                    [nzDisabled]="unitType.get('isSaved')?.value"
                  >
                    @for (type of unitTypesOptions; track type.id) {
                      <nz-option [nzValue]="type.id" [nzLabel]="type.name"></nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </div>
              <div class="flex flex-col gap-2 my-12 mb-2">
                <label [for]="'price_' + i" class="text-gray-500 text-xs font-medium">
                  Amount
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control nzErrorTip="Please enter a valid price">
                  <input
                    nz-input
                    [id]="'price_' + i"
                    formControlName="price"
                    placeholder="Enter property price"
                    class="w-full"
                    [nzSize]="'large'"
                    [readonly]="unitType.get('isSaved')?.value"
                    [currencyMask]="{ prefix: '₦ ', thousands: ',', decimal: '.', align: 'left' }"
                  />
                </nz-form-control>
              </div>
              <div class="flex flex-col gap-2 mt-12">
                <label [for]="'total_units_' + i" class="text-gray-500 text-xs font-medium">
                  Total Units
                </label>
                <nz-form-control nzErrorTip="Please enter a valid total units">
                  <input
                    nz-input
                    [id]="'total_units_' + i"
                    formControlName="total_units"
                    placeholder="Enter total units"
                    class="w-full"
                    [nzSize]="'large'"
                    [readonly]="unitType.get('isSaved')?.value"
                  />
                </nz-form-control>
              </div>
              
              <div class="flex justify-end mt-6 border-t border-gray-200 pt-6">
                <button
                  type="button"
                  class="flex items-center bg-transparent border-none p-0 cursor-pointer disabled:!text-gray-200 disabled:cursor-not-allowed"
                  nz-popconfirm
                  nzPopconfirmTitle="Are you sure you want to delete this unit?"
                  (nzOnConfirm)="removeUnitType(i)"
                  [nzPopconfirmPlacement]="'top'"
                  [disabled]="isLoading || unitTypes.length <= 1 || unitSaved"
                >
                  <app-icon class="!text-gray-500 !text-sm" name="trash"></app-icon>
                  <span class="!text-gray-500 !text-sm ml-2">Delete Unit</span>
                </button>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-end gap-6 my-12">
             <button
                type="submit"
                class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
                [disabled]="isLoading || unitTypeForm.invalid || unitSaved"
                (click)="submitUnits()">Save & Continue
              </button>
        </div>
          <ng-template #noUnitTypes>
            <div *ngIf="!isLoading" class="text-gray-500">
              No unit types available. Please try again later.
            </div>
          </ng-template>
        </div>
      </form>

      <!-- <form *ngIf="createdProperty?.property_units?.length" nz-form [formGroup]="installmentPlanForm" class="w-full"> -->
      <form *ngIf="unitSaved" nz-form [formGroup]="installmentPlanForm" class="w-full" id="plans-section">
        <div class="flex flex-col gap-6">
            <div class="flex justify-end gap-4">
              <button
                type="button"
                class="!text-primary hover:text-red-800 text-sm font-medium cursor-pointer disabled:!text-gray-200 disabled:cursor-not-allowed"
                (click)="addInstallmentPlan()"
                [disabled]="isLoading"
              >
                + Add installment Plan
              </button>
              
            </div>
          <div formArrayName="installment_plans" class="flex flex-col gap-6 bg-gray-100 p-6 rounded-lg border border-gray-200">
            <div *ngFor="let unitType of installmentPlans.controls; let i = index; trackBy: trackByInstallmentPlan" [formGroupName]="i">
              <div class="flex flex-col gap-2 mb-2">
                <label [for]="'unit_id_' + i" class="text-gray-500 text-xs font-medium">
                  Unit
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control nzErrorTip="Please select a unit type">
                  <nz-select
                    [id]="'unit_id_' + i"
                    formControlName="unit_id"
                    nzPlaceHolder="Select a unit for this property"
                    class="w-full"
                    [nzSize]="'large'"
                    [nzDisabled]="installmentPlans.get('isSaved')?.value"
                  >
                    @for (data of createdProperty?.property_units; track data.id) {
                      <nz-option [nzValue]="data.id" [nzLabel]="data.unit_type.name"></nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </div>
              <div class="flex flex-col gap-2 mb-2 mt-12">
                <label [for]="'plan_id_' + i" class="text-gray-500 text-xs font-medium">
                  Installment Type
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control>
                  <nz-select
                    [id]="'plan_id_' + i"
                    formControlName="plan_id"
                    nzPlaceHolder="Select an installment type"
                    class="w-full"
                    [nzSize]="'large'"
                  >
                    @for (option of installmentPlanOptions; track option.id) {
                      <nz-option [nzValue]="option.id" [nzLabel]="option.title"></nz-option>
                    }
                  </nz-select>
                </nz-form-control>
              </div>
              <div class="flex flex-col gap-2 mb-2 mt-12">
                <label [for]="'initial_amount_' + i" class="text-gray-500 text-xs font-medium">
                  Initial Deposit
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control nzErrorTip="Please enter a valid initial amount">
                  <input
                    nz-input
                    [id]="'initial_amount_' + i"
                    formControlName="initial_amount"
                    placeholder="Enter initial amount"
                    type="text"
                    class="w-full"
                    [nzSize]="'large'"
                    [currencyMask]="{ prefix: '₦ ', thousands: ',', decimal: '.', align: 'left' }"
                  />
                </nz-form-control>
              </div>
              <div class="flex flex-col gap-2 mb-2 mt-12">
                <label [for]="'total_price_' + i" class="text-gray-500 text-xs font-medium">
                  Total Amount
                  <span nz-tooltip nzTooltipTitle="Required field" class="text-red-500">*</span>
                </label>
                <nz-form-control nzErrorTip="Please enter a valid total price">
                  <input
                    nz-input
                    [id]="'total_price_' + i"
                    formControlName="total_price"
                    placeholder="Enter total amount"
                    type="text"
                    class="w-full"
                    [nzSize]="'large'"
                    [currencyMask]="{ prefix: '₦ ', thousands: ',', decimal: '.', align: 'left' }"
                  />
                </nz-form-control>
              </div>
              
              <div class="flex justify-end mt-6 border-t border-gray-200 pt-6">
                <button
                  type="button"
                  class="flex items-center bg-transparent border-none p-0 cursor-pointer disabled:!text-gray-200 disabled:cursor-not-allowed"
                  nz-popconfirm
                  nzPopconfirmTitle="Are you sure you want to delete this plan?"
                  (nzOnConfirm)="removeInstallmentPlan(i)"
                  [nzPopconfirmPlacement]="'top'"
                  [disabled]="isLoading || installmentPlans.length <= 1"
                >
                  <app-icon class="!text-gray-500 !text-sm" name="trash"></app-icon>
                  <span class="!text-gray-500 !text-sm ml-2">Delete Plan</span>
                </button>
              </div>
            </div>
          </div>
          <div class="flex items-center justify-end gap-6 my-12">
             <button
                type="submit"
                class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
                [disabled]="isLoading || installmentPlanForm.invalid"
                (click)="submitPlans()">Save & Continue
              </button>
              <button
                type="submit"
                class="rounded-lg bg-primary py-3 px-10 text-[20px] !text-white font-medium cursor-pointer disabled:!bg-gray-100 disabled:cursor-not-allowed"
                (click)="skip()">Skip & View Property
              </button>
        </div>
          <ng-template #noUnitTypes>
            <div *ngIf="!isLoading" class="text-gray-500">
              No unit types available. Please try again later.
            </div>
          </ng-template>
        </div>
      </form>
    </div>
  }
 </div>

</main>
